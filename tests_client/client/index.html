<!DOCTYPE html>
<html>
<head>
   <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.js"></script>
   <script type="text/javascript">
      var sock = null;
      var ellog = null;

      /**
       * Base Interface to communicate with Desktop client
       *
       * Protocol format:
       * message
       * {
       *     protocol_version: Number
       *     id: Number
       *     timestamp: Date
       *     command:
       *         name: String (ShotgunAPI method)
       *         data: Any object
       * }
       */
      function DesktopClient() {
         this.protocol_version = 1;    // Using this server protocol
         this.socket = undefined;
         this.listeners = {};          // Message subscribers
      }

      /**
       * Create a message object form a command object.
       * This will add message information necessary for communication, such as protocol version, etc...
       *
       * @param command Command object to add to message
       * @returns message object
       */
      DesktopClient.prototype._messageFromCommand = function(command) {
         var message = {
            protocol_version: this.protocol_version,
            id: Date.now(),
            timestamp: Date.now(),
            command: command
         };

         return message;
      };

      /**
       * Add a listener to given message
       * @param message Message to add listener for
       * @param callback Action to take upon receiving reply to message
       */
      DesktopClient.prototype._addMessageListener = function(message, callback) {
         if (!this.listeners.hasOwnProperty([message.id])) {
            this.listeners[message.id] = [];
         }

         var listeners = this.listeners[message.id];
         listeners.push(callback);
      };

      DesktopClient.prototype.handleError = function(message) {
         log("Got Server Error: " + message.error_message);
         log(message);
      };

      /**
       * Initialize to given websocket
       *
       * @param websocket to initialize with
       */
      DesktopClient.prototype.initialize = function(websocket) {
         this.socket = websocket;

         if (this.socket) {
            this.socket.onmessage = this.onMessage.bind(this);
         }
      };

      /**
       * Find all clients of a message an dispatch to them
       */
      DesktopClient.prototype.dispatchMessage = function(message) {
         var listeners = this.listeners[message.id];     // Retrive message subscribers

         // Callback all listeners for message
         if (Array.isArray(listeners)) {
            listeners.forEach(function (listener) {
               listener(message);
            });

            delete this.listeners[message.id];
         }
      };

      /**
       *
       * @param e Websocket event
       */
      DesktopClient.prototype.onMessage = function(e) {
         log("Got Server Message: " + e.data);

         try {
            var message = JSON.parse(e.data)
         } catch (error) {
            console.error("Error retrieving data. Message may not be in Json format.");
            console.error(error);

            return;
         }

         if (message.error) {
            this._handleError(message);
         } else {
            // Dispatch message to listeners awaiting reply
            this.dispatchMessage(message);
         }
      };


      /**
       * Send command to server.
       *
       * @param command Command data to send with format {command: '' data: {}}
       * @callback Callback when command is done
       */
      DesktopClient.prototype.send = function(command, callback) {
         if (this.socket) {
            callback = callback || function() {};

            var message = this._messageFromCommand(command);

            try {
               var messageString = JSON.stringify(message);
            } catch (error) {
               console.error("Error stringifying JSON. Can't send command.");
               console.error(error);

               return;
            }

            this._addMessageListener(message, callback);
            this.socket.send(messageString);
            log("Sent: " + messageString);
         } else {
            console.error("Cannot send command while not connected.");
         }
      };


      /**
       * Desktop API Methods
       * @constructor
       * @param client Interface instance used to communicate with desktop (eg: DesktopClient).
       */
      function DesktopAPI(client) {
         this.client = client
      }

      /**
       *
       * @param message
       * @param callback Callback arguments: message: String
       */
      DesktopAPI.prototype.echo = function(message, callback) {
         callback = callback || function() {};

         this.client.send({
            name: 'echo',
            data: {message: message}
         }, function(message) {
            callback(message.reply.message);
         });
      };

      desktopClient = new DesktopClient();
      desktopApi = new DesktopAPI(desktopClient);

      window.onload = function() {

         var wsuri;
         ellog = document.getElementById('log');

         wsuri = "wss://localhost:9000";

         if ("WebSocket" in window) {
            sock = new WebSocket(wsuri);
         } else if ("MozWebSocket" in window) {
            sock = new MozWebSocket(wsuri);
         } else {
            log("Browser does not support WebSocket!");
            window.location = "http://autobahn.ws/unsupportedbrowser";
         }

         if (sock) {
            sock.onopen = function() {
               log("Connected to " + wsuri);
            }

            sock.onclose = function(e) {
               log("Connection closed (wasClean = " + e.wasClean + ", code = " + e.code + ", reason = '" + e.reason + "')");
            }

            sock.onmessage = function(e) {log("On message..");};
         }

         desktopClient.initialize(sock);
      };

      function log(m) {
         document.getElementById('log').innerHTML += m + '\n';
      };

      function send(cmd) {
         if (sock) {
            var cmdString = JSON.stringify(cmd);
            sock.send(cmdString);
            log("Sent: " + cmdString);
         } else {
            log("Not connected.");
         }
      }

      function open_cmd() {
         var filepath = document.getElementById('filepath').value;
         cmd = {
            name: 'open',
            data: {filepath: filepath}
         };

         send(cmd)
      };

      function echo() {
         var msg = document.getElementById('message').value;

         desktopApi.echo(msg, function(message) {
            log("Echo Received: " + message);
         });
      };

      function pickFileOrDirectory() {
         cmd = {name: 'pickFileOrDirectory'};
         send(cmd)
      };

      function getVersion() {
         cmd = {name: 'version'};
         send(cmd)
      };

      function pickFileOrDirectories() {
         cmd = {name: 'pickFileOrDirectories'};
         send(cmd)
      };

      function sgtkCommand() {
         var command = document.getElementById('sgtk_command').value;
         var args = JSON.parse(document.getElementById('sgtk_args').value || "[]");
         var pipelineConfigPath = document.getElementById('sgtk_pipelineConfigPath').value;
         cmd = {
            name: 'executeToolkitCommand',
            data: {
               command: command,
               args: args,
               pipelineConfigPath: pipelineConfigPath
            }
         };

         send(cmd)
      };
   </script>
</head>

<body>
    <h1>Shotgun Secure WebSocket Client Test</h1>
    <noscript>You must enable JavaScript</noscript>

    <div>
        <p>
            <span>If you have trouble connecting, make sure you have installed the </span><a href="certificate.html">certificate</a><span>!</span>
        </p>
    </div>

    <div>
       <button onclick='echo();'>Send Message</button>
       <input id="message" type="text" size="50" value="Hello, world!">
    </div>
    <div>
       <button onclick='open_cmd();'>Open file</button>
       <input id="filepath" type="text" size="50" value="/Users/rivestm/tmp.txt">
    </div>
    <div>
       <button onclick='getVersion();'>Get Server API Version</button>
    </div>
    <div>
       <button onclick='pickFileOrDirectory();'>Pick File Or Directory</button>
    </div>
    <div>
       <button onclick='pickFileOrDirectories();'>Pick File Or Directories</button>
    </div>
    <div>
       <button onclick='sgtkCommand();'>Execute Toolkit Command</button>
       <input id="sgtk_pipelineConfigPath" type="text" size="50" value="/Users/rivestm/shotgun/toolkit/config24" placeholder="Pipeline Configuration">
       <input id="sgtk_command" type="text" size="50" maxlength="50" value="shotgun_cache_actions" placeholder="Toolkit Command">
       <input id="sgtk_args" type="text" size="50" maxlength="50" value='' placeholder='Argument list as JSON list (ex: ["myarg"]'>
    </div>

    <pre id="log" style="height: 20em; overflow-y: scroll; background-color: #faa;"></pre>
</body>
</html>
